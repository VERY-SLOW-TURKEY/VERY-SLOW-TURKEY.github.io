<!DOCTYPE html>
<html>
<head>
<title>Online Game</title>
<style>
body {margin:0;}
</style>
</head>
<body>
<script src="three.js"></script>
<script src="PointerLockControls.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
apiKey: "AIzaSyAMDj5Cog1xiuK5cfZsWQFToykncdOZeAI",
authDomain: "online-game-4af9e.firebaseapp.com",
databaseURL: "https://online-game-4af9e-default-rtdb.firebaseio.com",
projectId: "online-game-4af9e",
storageBucket: "online-game-4af9e.appspot.com",
messagingSenderId: "342143193117",
appId: "1:342143193117:web:abcb38a2d6d7ccbc8e36f4"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);

var canvas = document.createElement('canvas');
canvas.height = window.innerHeight / 1.005;
canvas.width = window.innerWidth / 1.005;
var c = canvas.getContext('2d');
  
// threejs setup code
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
const renderer = new THREE.WebGLRenderer();
renderer.setSize( window.innerWidth, window.innerHeight );
document.body.appendChild( renderer.domElement );
var controls = new THREE.PointerLockControls(camera, document.body);
  
document.onclick = function(event) {
controls.lock();
}

window.requestAnimationFrame(gameLoop);
window.addEventListener('keyup', keyUp);
window.addEventListener('keydown', keyDown);

// variables
var players = {};
var playerId = '';
var aDown = false;
var dDown = false;
var wDown = false;
var sDown = false;
var playerPos = Math.random() * window.innerWidth;
var playerX = 0;
var shapes3d = {};
  
const geometry = new THREE.BoxGeometry( 1, 1, 1 );
const material = new THREE.MeshBasicMaterial( { color: 0x808080 } );

allPlayersRef = firebase.database().ref('players');
  
firebase.auth().onAuthStateChanged((user) => {
console.log(user);
playerId = user.uid;
playerRef = firebase.database().ref('players/' + playerId);
playerRef.set({
id: playerId,
x: Math.random() * 20,
y: Math.random() * 20
});
start();
})
  
firebase.auth().signInAnonymously().catch((error) => {
var errorCode = error.code;
var errorMessage = error.message;
console.log(errorCode, errorMessage);
});
  
function gameLoop() {
move();
renderer.render(scene, camera);
window.requestAnimationFrame(gameLoop);
}


function start() {
allPlayersRef.on('value', (snapshot) => {
//players[Object.values(snapshot.val())[0].id] = snapshot.val();
var players = snapshot.val() || {};
c.fillStyle = 'white';
c.fillRect(0, 0, window.innerWidth, window.innerHeight);
Object.keys(players).forEach((key) => {
c.fillStyle = 'grey';
c.fillRect(players[key].x, players[key].y, 40, 40);
shapes3d[players[key].id].position.x = players[key].x;
shapes3d[players[key].id].position.z = players[key].y;
camera.position.x = players[key].x;
camera.position.z = players[key].y;
});
});
  
allPlayersRef.on('child_added', (snapshot) => {
var newPlayer = snapshot.val();
c.fillStyle = 'grey';
c.fillRect(newPlayer.x, newPlayer.y, 40, 40);
players[newPlayer.id] = newPlayer;
shapes3d[newPlayer.id] = new THREE.Mesh( geometry, material );
scene.add(shapes3d[newPlayer.id]);
});

allPlayersRef.on('child_removed', (snapshot) => {
scene.remove(snapshot.val().id);
});
  
playerRef.onDisconnect().remove();
}

function draw() {
c.fillStyle = 'white';
c.fillRect(0, 0, window.innerHeight, window.innerWidth);
}

function drawPlayers() {
for(i = 0; i < players.length; i++) {
c.fillStyle = 'grey';
c.fillRect(Object.values(players)[i].x, Object.values(players)[i].y, 40, 40);
}
}

function keyDown(event) {
if (event.key == 'a') {aDown = true;}
if (event.key == 'd') {dDown = true;}
if (event.key == 'w') {wDown = true;}
if (event.key == 's') {sDown = true;}
}

function keyUp(event) {
if (event.key == 'a') {aDown = false;}
if (event.key == 'd') {dDown = false;}
if (event.key == 'w') {wDown = false;}
if (event.key == 's') {sDown = false;}
}

function move() {
if (aDown) {
var newX = players[playerId].x + 0.1;
players[playerId].x = newX;
playerRef.set(players[playerId]);
}
if (dDown) {
var newX = players[playerId].x - 0.1;
players[playerId].x = newX;
playerRef.set(players[playerId]);
}
if (wDown) {
var oldCamera = camera;
controls.moveForward(.1);
var cameraDifX = camera.position.x - oldCamera.position.x;
console.log(cameraDifX);
var cameraDifY = camera.position.z - oldCamera.position.z;
var newY = players[playerId].y + cameraDifY;
var newX = players[playerId].x + cameraDifX;
players[playerId].y = newY;
players[playerId].x = newX;
playerRef.set(players[playerId]);
}
if (sDown) {
var newY = players[playerId].y + 0.1;
players[playerId].y = newY;
playerRef.set(players[playerId]);
}
}
  
document.body.appendChild(canvas);
</script>
</body>
</html>

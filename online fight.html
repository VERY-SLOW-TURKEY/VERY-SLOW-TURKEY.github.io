<!DOCTYPE html>
<html>
<head>
<title>Online Fight</title>
<style>
body {
margin:0;
background-image: url('sand.jpg');
}
#loading {
position: fixed;
top: 75%;
text-align: center;
font-size: 400%;
}
</style>
</head>
<body>
<p id="loading">Loading...</p>
<script src="three.js"></script>
<script src="PointerLockControls.js"></script>
<script src="GLTFLoader.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
apiKey: "AIzaSyCA4YNKe60o0kyi-8xpSWlKCtlq0LTIE5U",
authDomain: "online-fight-67e35.firebaseapp.com",
databaseURL: "https://online-fight-67e35-default-rtdb.firebaseio.com",
projectId: "online-fight-67e35",
storageBucket: "online-fight-67e35.appspot.com",
messagingSenderId: "223694414798",
appId: "1:223694414798:web:d1b37aa22987e24961c19f"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);

// variables
var players = {};
var playerId = '';
var shapes3d = {};
var hitboxes3d = {};
var aDown = false;
var dDown = false;
var wDown = false;
var sDown = false;
var gameLoaded = false;
var lookX = 0;
var lookY = 0;
var mouseDown = 0;
var rightMouseDown = 0;
var playerHealth = 100;
var playerInGame = false;
var jumping = 0;
  
allPlayersRef = firebase.database().ref('players');
attackRef = firebase.database().ref('attack');
  
firebase.auth().signInAnonymously().catch((error) => {
var errorCode = error.code;
var errorMessage = error.message;
console.log(errorCode, errorMessage);
});
  
firebase.auth().onAuthStateChanged((user) => {
playerId = user.uid;
playerRef = firebase.database().ref('players/' + playerId);
playerRef.set({
id: playerId,
x: Math.random() * 20,
y: 0,
z: Math.random() * 20,
rotation: 0,
health: playerHealth,
inGame: playerInGame
});
})

window.addEventListener('keyup', keyUp);
window.addEventListener('keydown', keyDown);
window.addEventListener('mousemove', mouseMove);
const raycaster = new THREE.Raycaster();
const pointer = new THREE.Vector2();
pointer.x = 0;
pointer.y = 0;
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
const renderer = new THREE.WebGLRenderer();
renderer.setSize( window.innerWidth, window.innerHeight );
document.body.appendChild( renderer.domElement );
var controls = new THREE.PointerLockControls(camera, document.body);
renderer.shadowMap.enabled = true;

// level
const light = new THREE.PointLight(0xffffff, 3);
light.position.set(25, 50, 25);
scene.add(light);
light.castShadow = true;
const ambLight = new THREE.AmbientLight(0xffffff, 0.5);
scene.add(ambLight);
const sandFloorGeo = new THREE.BoxGeometry(100, 1, 100);
const sandTexture = new THREE.TextureLoader().load('./sand.jpg');
const sandMat = new THREE.MeshLambertMaterial({
color: 0xd2aa6d,
emissive: 0x000000,
map: sandTexture
});
const sandFloor = new THREE.Mesh(sandFloorGeo, sandMat);
scene.add(sandFloor);
sandFloor.position.y = -1;
sandFloor.receiveShadow = true;
sandFloor.castShadow = true;
const cubeGeo = new THREE.BoxGeometry(1, 2, 1);
const blueMat = new THREE.MeshLambertMaterial({
color: 0x0000ff,
emissive: 0x000000
});
const cube = new THREE.Mesh(cubeGeo, blueMat);
scene.add(cube);
cube.visible = false;

document.onclick = function(event) {
controls.lock();
}
  
window.onmousedown = (event) => {  
++mouseDown;
if (event.button == 2) {
++rightMouseDown;
}
}  
window.onmouseup = () => {  
--mouseDown;
if (event.button == 2) {
--rightMouseDown;
}
}

function gameLoop() {
if (gameLoaded) {
renderer.render(scene, camera);
move();
shootMachineGun();
placeHitbox();
solidWalls(cube);
gravity();
jump();
}
requestAnimationFrame(gameLoop);
}
gameLoop();

function keyDown(event) {
const k = event.key;
if (k == 'a') {aDown = true;}
if (k == 'd') {dDown = true;}
if (k == 'w') {wDown = true;}
if (k == 's') {sDown = true;}
if (k == ' ') {camera.position.y += 0.1;}
if (k == 'f') {document.documentElement.requestFullscreen();}
if (k == 'e' && gameLoaded) {playerInGame = true;}
if (k == ' ') {if (collideSolids(bottom(cube))) {jumping = 10;}}
}

function keyUp(event) {
const k = event.key;
if (k == 'a') {aDown = false;}
if (k == 'd') {dDown = false;}
if (k == 'w') {wDown = false;}
if (k == 's') {sDown = false;}
}

function move() {
if (wDown) {controls.moveForward(.1);}
if (sDown) {controls.moveForward(-.1);}
if (aDown) {controls.moveRight(-.1);}
if (dDown) {controls.moveRight(.1);}
playerRef.set({
id: playerId,
x: camera.position.x,
y: camera.position.y - 1,
z: camera.position.z,
rotation: lookX + Math.PI,
health: playerHealth,
inGame: playerInGame
});
}

const gltfLoader = new THREE.GLTFLoader();
gltfLoader.load('./swat/scene.gltf', (gltfScene) => {
  scene.add(gltfScene.scene);
  gltfScene.scene.scale.set(0.01, 0.01, 0.01);
  gltfScene.scene.position.y = -1;
  gltfScene.scene.rotation.y = 0;
  document.getElementById("loading").hidden = true;
  gameLoaded = true;
  start();
});
  
gltfLoader.load('./swat/scene.gltf', (gltfScene2) => {
  scene.add(gltfScene2.scene);
  gltfScene2.scene.scale.set(0.01, 0.01, 0.01);
  gltfScene2.scene.position.set(5, -1, 5);
  gltfScene2.scene.rotation.y = Math.PI;
});
  
function start() {
allPlayersRef.on('value', (snapshot) => {
var players = snapshot.val() || {};
Object.keys(players).forEach((key) => {
if (shapes3d[players[key].id] != undefined) {
shapes3d[players[key].id].position.x = players[key].x;
shapes3d[players[key].id].position.z = players[key].z;
shapes3d[players[key].id].position.y = players[key].y;
shapes3d[players[key].id].rotation.y = players[key].rotation;
hitboxes3d[players[key].id].position.x = players[key].x;
hitboxes3d[players[key].id].position.z = players[key].z;
hitboxes3d[players[key].id].position.y = players[key].y + 1;
if (players[key].inGame) {
playerInGame = true;
}
}
});
});
  
allPlayersRef.on('child_added', (snapshot) => {
var newPlayer = snapshot.val();
players[newPlayer.id] = newPlayer;
if(!newPlayer.inGame) {
if (newPlayer.id != playerId) {
gltfLoader.load('./swat/scene.gltf', (gltfScene) => {
  gltfScene.scene.scale.set(0.01, 0.01, 0.01);
  scene.add(gltfScene.scene);
  shapes3d[newPlayer.id] = gltfScene.scene;
});
hitboxes3d[newPlayer.id] = new THREE.Mesh(cubeGeo, blueMat);
scene.add(hitboxes3d[newPlayer.id]);
hitboxes3d[newPlayer.id].visible = false;
}
}
});
  
attackRef.on('value', (snapshot) => {
var damage = snapshot.val() || {};
if (damage.target == playerId) {
playerHealth -= damage.amount;
}
if (playerHealth <= 0) {
window.location.href = "dead.htm";
}
});

allPlayersRef.on('child_removed', (snapshot) => {
scene.remove(shapes3d[snapshot.val().id]);
delete shapes3d[snapshot.val().id];
scene.remove(hitboxes3d[snapshot.val().id]);
delete hitboxes3d[snapshot.val().id];
delete players[snapshot.val().id];
});
playerRef.onDisconnect().remove();
}
  
function mouseMove(event) {
if (controls.isLocked) {
lookX -= event.movementX / 500;
lookX = Number(lookX.toFixed(3));
lookY -= event.movementY / 500;
lookY = Number(lookY.toFixed(3));
camera.rotation.y = Number(camera.rotation.y.toFixed(3));
camera.rotation.x = Number(camera.rotation.x.toFixed(3));
}
}
  
window.onresize = function() {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
}
  
function shootMachineGun() {
if (mouseDown) {
raycaster.setFromCamera( pointer, camera );
var shot = raycaster.intersectObjects( scene.children )[0];
if (shot != undefined) {
shot = shot.object;
for(i = 0; i < Object.values(hitboxes3d).length; i++) {
if (Object.values(hitboxes3d)[i] == shot) {
console.log(Object.keys(hitboxes3d)[i]);
attackRef.set({
target: Object.keys(hitboxes3d)[i],
amount: Math.random() * 5
});
}
}
}
}
}
  
// jumping mechanics
function collideSolids(mesh) {
for (i = 0; i<scene.children.length; i++) {
if (scene.children[i].type == 'Mesh') {
var mesh2 = scene.children[i];
var meshXRight = mesh.position.x + mesh.geometry.parameters.width / 2;
var meshXLeft = mesh.position.x - mesh.geometry.parameters.width / 2;
var meshYUp = mesh.position.y + mesh.geometry.parameters.height / 2;
var meshYDown = mesh.position.y - mesh.geometry.parameters.height / 2;
var meshZRight = mesh.position.z + mesh.geometry.parameters.depth / 2;
var meshZLeft = mesh.position.z - mesh.geometry.parameters.depth / 2;

var mesh2XRight = mesh2.position.x + mesh2.geometry.parameters.width / 2;
var mesh2XLeft = mesh2.position.x - mesh2.geometry.parameters.width / 2;
var mesh2YUp = mesh2.position.y + mesh2.geometry.parameters.height / 2;
var mesh2YDown = mesh2.position.y - mesh2.geometry.parameters.height / 2;
var mesh2ZRight = mesh2.position.z + mesh2.geometry.parameters.depth / 2;
var mesh2ZLeft = mesh2.position.z - mesh2.geometry.parameters.depth / 2;
if (meshXRight >= mesh2XLeft && meshXLeft <= mesh2XRight && meshYUp >= mesh2YDown && meshYDown <= mesh2YUp && meshZRight >= mesh2ZLeft && meshZLeft <= mesh2ZRight) {
return true;
}
}
}
return false;
}

function right(mesh) {
var rightMesh = {
position:{x: mesh.position.x + mesh.geometry.parameters.width / 2 + 0.1, y: mesh.position.y + 0.1, z: mesh.position.z},
geometry:{parameters:{width: 0, height: mesh.geometry.parameters.height / 2, depth: mesh.geometry.parameters.depth / 2}}
}
return rightMesh;
}
function left(mesh) {
var leftMesh = {
position:{x: mesh.position.x - mesh.geometry.parameters.width / 2 - 0.1, y: mesh.position.y + 0.1, z: mesh.position.z},
geometry:{parameters:{width: 0, height: mesh.geometry.parameters.height / 2, depth: mesh.geometry.parameters.depth / 2}}
}
return leftMesh;
}
function front(mesh) {
var frontMesh = {
position:{x: mesh.position.x, y: mesh.position.y + 0.1, z: mesh.position.z + mesh.geometry.parameters.depth / 2 + 0.1},
geometry:{parameters:{width: mesh.geometry.parameters.width / 2, height: mesh.geometry.parameters.height / 2, depth: 0}}
}
return frontMesh;
}
function back(mesh) {
var backMesh = {
position:{x: mesh.position.x, y: mesh.position.y += 0.1, z: mesh.position.z - mesh.geometry.parameters.depth / 2 - 0.1},
geometry:{parameters:{width: mesh.geometry.parameters.width / 2, height: mesh.geometry.parameters.height / 2, depth: 0}}
}
return backMesh;
}
function tip(mesh) {
var topMesh = {
position:{x: mesh.position.x, y: mesh.position.y + mesh.geometry.parameters.height / 2 + 0.1, z: mesh.position.z},
geometry:{parameters:{width: mesh.geometry.parameters.width / 2, height: 0, depth: mesh.geometry.parameters.depth / 2}}
}
return topMesh;
}
function bottom(mesh) {
var bottomMesh = {
position:{x: mesh.position.x, y: mesh.position.y - mesh.geometry.parameters.height / 2 - 0.1, z: mesh.position.z},
geometry:{parameters:{width: mesh.geometry.parameters.width / 2, height: 0, depth: mesh.geometry.parameters.depth / 2}}
}
return bottomMesh;
}

function placeHitbox() {
cube.position.set(camera.position.x, camera.position.y, camera.position.z);
}

function jump() {
if (jumping) {jumping -= 1; camera.position.y += 0.8;}
}

function gravity() {
console.log(collideSolids(bottom(cube)));
if (!collideSolids(bottom(cube))) {camera.position.y -= 0.09; console.log(camera.position.y);}
}

function solidWalls(mesh) {
var keysDown = 0;
if (wDown) {keysDown ++;}
if (aDown) {keysDown ++;}
if (sDown) {keysDown ++;}
if (dDown) {keysDown ++;}
if ( collideSolids( right(mesh) ) ) {
console.log('touch');
if (keysDown >= 2) {
camera.position.x -= 0.15;
} else {
camera.position.x -= 0.1;
}
}
if ( collideSolids( left(mesh) ) ) {
if (keysDown >= 2) {
camera.position.x += 0.15;
} else {
camera.position.x += 0.1;
}
}
if ( collideSolids( front(mesh) ) ) {
if (keysDown >= 2) {
camera.position.z -= 0.15;
} else {
camera.position.z -= 0.1;
}
}
if ( collideSolids( back(mesh) ) ) {
if (keysDown >= 2) {
camera.position.z += 0.15;
} else {
camera.position.z += 0.1;
}
}
}
  
console.log('test 39');

// credits
// "Swat" (https://skfb.ly/6FTNV) by doctortex is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/).

</script>
</body>
</html>
